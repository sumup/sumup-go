// Code generated by `go-sdk-gen`. DO NOT EDIT.

package subaccounts

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"net/url"
	"strconv"
	"time"

	"github.com/sumup/sumup-go/client"
	"github.com/sumup/sumup-go/shared"
)

// Operator: Operator account for a merchant.
type Operator struct {
	AccountType OperatorAccountType `json:"account_type"`
	// The timestamp of when the operator was created.
	CreatedAt time.Time `json:"created_at"`
	Disabled  bool      `json:"disabled"`
	// Format: int32
	ID       int32   `json:"id"`
	Nickname *string `json:"nickname,omitempty"`
	// Permissions assigned to an operator or user.
	Permissions Permissions `json:"permissions"`
	// The timestamp of when the operator was last updated.
	UpdatedAt time.Time `json:"updated_at"`
	Username  string    `json:"username"`
}

// OperatorAccountType is a schema definition.
type OperatorAccountType string

const (
	OperatorAccountTypeNormal   OperatorAccountType = "normal"
	OperatorAccountTypeOperator OperatorAccountType = "operator"
)

// Permissions: Permissions assigned to an operator or user.
type Permissions struct {
	Admin                      bool `json:"admin"`
	CreateMotoPayments         bool `json:"create_moto_payments"`
	CreateReferral             bool `json:"create_referral"`
	FullTransactionHistoryView bool `json:"full_transaction_history_view"`
	RefundTransactions         bool `json:"refund_transactions"`
}

// CreateSubAccount is a schema definition.
type CreateSubAccount struct {
	Nickname *string `json:"nickname,omitempty"`
	// Min length: 8
	Password    string                       `json:"password"`
	Permissions *CreateSubAccountPermissions `json:"permissions,omitempty"`
	// Format: email
	Username string `json:"username"`
}

// CreateSubAccountPermissions is a schema definition.
type CreateSubAccountPermissions struct {
	CreateMotoPayments         *bool `json:"create_moto_payments,omitempty"`
	CreateReferral             *bool `json:"create_referral,omitempty"`
	FullTransactionHistoryView *bool `json:"full_transaction_history_view,omitempty"`
	RefundTransactions         *bool `json:"refund_transactions,omitempty"`
}

// UpdateSubAccount is a schema definition.
type UpdateSubAccount struct {
	Disabled *bool   `json:"disabled,omitempty"`
	Nickname *string `json:"nickname,omitempty"`
	// Min length: 8
	Password    *string                      `json:"password,omitempty"`
	Permissions *UpdateSubAccountPermissions `json:"permissions,omitempty"`
	// Format: email
	// Max length: 256
	Username *string `json:"username,omitempty"`
}

// UpdateSubAccountPermissions is a schema definition.
type UpdateSubAccountPermissions struct {
	CreateMotoPayments         *bool `json:"create_moto_payments,omitempty"`
	CreateReferral             *bool `json:"create_referral,omitempty"`
	FullTransactionHistoryView *bool `json:"full_transaction_history_view,omitempty"`
	RefundTransactions         *bool `json:"refund_transactions,omitempty"`
}

// ListSubAccountsParams: query parameters for ListSubAccounts
type ListSubAccountsParams struct {
	// If true the list of operators will include also the primary user.
	IncludePrimary *bool
	// Search query used to filter users that match given query term.
	//
	// Current implementation allow querying only over the email address.
	// All operators whos email address contains the query string are returned.
	Query *string
}

// QueryValues converts [ListSubAccountsParams] into [url.Values].
func (p *ListSubAccountsParams) QueryValues() url.Values {
	q := make(url.Values)

	if p.IncludePrimary != nil {
		q.Set("include_primary", strconv.FormatBool(*p.IncludePrimary))
	}

	if p.Query != nil {
		q.Set("query", *p.Query)
	}

	return q
}

// ListSubAccounts200Response is a schema definition.
type ListSubAccounts200Response []Operator

type SubaccountsService struct {
	c *client.Client
}

func NewSubaccountsService(c *client.Client) *SubaccountsService {
	return &SubaccountsService{c: c}
}

// ListSubAccounts: List operators
// Returns list of operators for currently authorized user's merchant.
// Deprecated: Subaccounts API is deprecated, to list users in your merchant account please use [List members](https://developer.sumup.com/api/members/list) instead.
func (s *SubaccountsService) ListSubAccounts(ctx context.Context, params ListSubAccountsParams) (*ListSubAccounts200Response, error) {
	path := fmt.Sprintf("/v0.1/me/accounts")

	resp, err := s.c.Call(ctx, http.MethodGet, path, client.WithQueryValues(params.QueryValues()))
	if err != nil {
		return nil, fmt.Errorf("error building request: %v", err)
	}
	defer resp.Body.Close()

	switch resp.StatusCode {
	case http.StatusOK:
		var v ListSubAccounts200Response
		if err := json.NewDecoder(resp.Body).Decode(&v); err != nil {
			return nil, fmt.Errorf("decode response: %s", err.Error())
		}

		return &v, nil
	default:
		return nil, fmt.Errorf("unexpected response %d: %s", resp.StatusCode, http.StatusText(resp.StatusCode))
	}
}

// CreateSubAccount: Create an operator
// Creates new operator for currently authorized users' merchant.
// Deprecated: Subaccounts API is deprecated, to create a user in your merchant account please use [Create member](https://developer.sumup.com/api/members/create)
// instead.
func (s *SubaccountsService) CreateSubAccount(ctx context.Context, body CreateSubAccount) (*Operator, error) {
	path := fmt.Sprintf("/v0.1/me/accounts")

	resp, err := s.c.Call(ctx, http.MethodPost, path, client.WithJSONBody(body))
	if err != nil {
		return nil, fmt.Errorf("error building request: %v", err)
	}
	defer resp.Body.Close()

	switch resp.StatusCode {
	case http.StatusOK:
		var v Operator
		if err := json.NewDecoder(resp.Body).Decode(&v); err != nil {
			return nil, fmt.Errorf("decode response: %s", err.Error())
		}

		return &v, nil
	case http.StatusForbidden:
		var apiErr shared.Problem
		if err := json.NewDecoder(resp.Body).Decode(&apiErr); err != nil {
			return nil, fmt.Errorf("read error response: %s", err.Error())
		}

		return nil, &apiErr
	default:
		return nil, fmt.Errorf("unexpected response %d: %s", resp.StatusCode, http.StatusText(resp.StatusCode))
	}
}

// DeactivateSubAccount: Disable an operator.
// Disable the specified operator for the merchant account.
// Deprecated: Subaccounts API is deprecated, to remove a user that's a member of your merchant account please
// use [Delete member](https://developer.sumup.com/api/members/delete) instead.
func (s *SubaccountsService) DeactivateSubAccount(ctx context.Context, operatorID int32) (*Operator, error) {
	path := fmt.Sprintf("/v0.1/me/accounts/%v", operatorID)

	resp, err := s.c.Call(ctx, http.MethodDelete, path)
	if err != nil {
		return nil, fmt.Errorf("error building request: %v", err)
	}
	defer resp.Body.Close()

	switch resp.StatusCode {
	case http.StatusOK:
		var v Operator
		if err := json.NewDecoder(resp.Body).Decode(&v); err != nil {
			return nil, fmt.Errorf("decode response: %s", err.Error())
		}

		return &v, nil
	default:
		return nil, fmt.Errorf("unexpected response %d: %s", resp.StatusCode, http.StatusText(resp.StatusCode))
	}
}

// CompatGetOperator: Retrieve an operator
// Returns specific operator.
// Deprecated: Subaccounts API is deprecated, to get a user that's a member of your merchant account please use
// [Get member](https://developer.sumup.com/api/members/get) instead.
func (s *SubaccountsService) CompatGetOperator(ctx context.Context, operatorID int32) (*Operator, error) {
	path := fmt.Sprintf("/v0.1/me/accounts/%v", operatorID)

	resp, err := s.c.Call(ctx, http.MethodGet, path)
	if err != nil {
		return nil, fmt.Errorf("error building request: %v", err)
	}
	defer resp.Body.Close()

	switch resp.StatusCode {
	case http.StatusOK:
		var v Operator
		if err := json.NewDecoder(resp.Body).Decode(&v); err != nil {
			return nil, fmt.Errorf("decode response: %s", err.Error())
		}

		return &v, nil
	default:
		return nil, fmt.Errorf("unexpected response %d: %s", resp.StatusCode, http.StatusText(resp.StatusCode))
	}
}

// UpdateSubAccount: Update an operator
// Updates operator. If the operator was disabled and their password is updated they will be unblocked.
// Deprecated: Subaccounts API is deprecated, to update a user that's a member of your merchant account please
// use [Update member](https://developer.sumup.com/api/members/update) instead.
func (s *SubaccountsService) UpdateSubAccount(ctx context.Context, operatorID int32, body UpdateSubAccount) (*Operator, error) {
	path := fmt.Sprintf("/v0.1/me/accounts/%v", operatorID)

	resp, err := s.c.Call(ctx, http.MethodPut, path, client.WithJSONBody(body))
	if err != nil {
		return nil, fmt.Errorf("error building request: %v", err)
	}
	defer resp.Body.Close()

	switch resp.StatusCode {
	case http.StatusOK:
		var v Operator
		if err := json.NewDecoder(resp.Body).Decode(&v); err != nil {
			return nil, fmt.Errorf("decode response: %s", err.Error())
		}

		return &v, nil
	case http.StatusBadRequest:
		var apiErr shared.Problem
		if err := json.NewDecoder(resp.Body).Decode(&apiErr); err != nil {
			return nil, fmt.Errorf("read error response: %s", err.Error())
		}

		return nil, &apiErr
	default:
		return nil, fmt.Errorf("unexpected response %d: %s", resp.StatusCode, http.StatusText(resp.StatusCode))
	}
}
