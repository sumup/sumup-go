// Code generated by `go-sdk-gen`. DO NOT EDIT.

package sumup

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"net/url"
	"strconv"
	"time"

	"github.com/sumup/sumup-go/client"
	"github.com/sumup/sumup-go/shared"
)

// A membership associates a user with a resource, memberships is defined by user, resource, resource type, and
// associated roles.
type Membership struct {
	// Object attributes that are modifiable only by SumUp applications.
	Attributes shared.Attributes `json:"attributes,omitempty"`
	// The timestamp of when the membership was created.
	CreatedAt time.Time `json:"created_at"`
	// ID of the membership.
	ID string `json:"id"`
	// Pending invitation for membership.
	Invite *shared.Invite `json:"invite,omitempty"`
	// Set of user-defined key-value pairs attached to the object. Partial updates are not supported. When updating, always
	// submit whole metadata. Maximum of 64 parameters are allowed in the object.
	// Max properties: 64
	Metadata shared.Metadata `json:"metadata,omitempty"`
	// User's permissions.
	// Deprecated: Permissions include only legacy permissions, please use roles instead. Member access is based on
	// their roles within a given resource and the permissions these roles grant.
	Permissions []string `json:"permissions"`
	// Information about the resource the membership is in.
	Resource MembershipResource `json:"resource"`
	// ID of the resource the membership is in.
	ResourceID string `json:"resource_id"`
	// User's roles.
	Roles []string `json:"roles"`
	// The status of the membership.
	Status shared.MembershipStatus `json:"status"`
	// The type of the membership resource.
	// Possible values are:
	// * `merchant` - merchant account(s)
	// * `organization` - organization(s)
	Type ResourceType `json:"type"`
	// The timestamp of when the membership was last updated.
	UpdatedAt time.Time `json:"updated_at"`
}

// Information about the resource the membership is in.
type MembershipResource struct {
	// Object attributes that are modifiable only by SumUp applications.
	Attributes shared.Attributes `json:"attributes,omitempty"`
	// The timestamp of when the membership resource was created.
	CreatedAt time.Time `json:"created_at"`
	// ID of the resource the membership is in.
	ID string `json:"id"`
	// Logo fo the resource.
	// Format: uri
	// Max length: 256
	Logo *string `json:"logo,omitempty"`
	// Display name of the resource.
	Name string `json:"name"`
	// The type of the membership resource.
	// Possible values are:
	// * `merchant` - merchant account(s)
	// * `organization` - organization(s)
	Type ResourceType `json:"type"`
	// The timestamp of when the membership resource was last updated.
	UpdatedAt time.Time `json:"updated_at"`
}

// The type of the membership resource.
// Possible values are:
// * `merchant` - merchant account(s)
// * `organization` - organization(s)
type ResourceType string

// MembershipsListParams are query parameters for ListMemberships.
type MembershipsListParams struct {
	// Filter memberships by resource kind.
	Kind *ResourceType
	// Maximum number of members to return.
	Limit *int
	// Offset of the first member to return.
	Offset *int
	// Filter memberships by the sandbox status of the resource the membership is in.
	ResourceAttributesSandbox *bool
	// Filter memberships by the name of the resource the membership is in.
	ResourceName *string
	// Filter memberships by the parent of the resource the membership is in.
	// When filtering by parent both `resource.parent.id` and `resource.parent.type` must be present. Pass explicit null
	// to filter for resources without a parent.
	ResourceParentID *string
	// Filter memberships by the parent of the resource the membership is in.
	// When filtering by parent both `resource.parent.id` and `resource.parent.type` must be present. Pass explicit null
	// to filter for resources without a parent.
	ResourceParentType *ResourceType
	// Filter memberships by resource kind.
	ResourceType *ResourceType
	// Filter the returned memberships by role.
	Roles []string
	// Filter the returned memberships by the membership status.
	Status *shared.MembershipStatus
}

// QueryValues converts [MembershipsListParams] into [url.Values].
func (p *MembershipsListParams) QueryValues() url.Values {
	q := make(url.Values)

	if p.Kind != nil {
		q.Set("kind", string(*p.Kind))
	}

	if p.Limit != nil {
		q.Set("limit", strconv.Itoa(*p.Limit))
	}

	if p.Offset != nil {
		q.Set("offset", strconv.Itoa(*p.Offset))
	}

	if p.ResourceAttributesSandbox != nil {
		q.Set("resource.attributes.sandbox", strconv.FormatBool(*p.ResourceAttributesSandbox))
	}

	if p.ResourceName != nil {
		q.Set("resource.name", *p.ResourceName)
	}

	if p.ResourceParentID != nil {
		q.Set("resource.parent.id", *p.ResourceParentID)
	}

	if p.ResourceParentType != nil {
		q.Set("resource.parent.type", string(*p.ResourceParentType))
	}

	if p.ResourceType != nil {
		q.Set("resource.type", string(*p.ResourceType))
	}

	for _, v := range p.Roles {
		q.Add("roles", v)
	}

	if p.Status != nil {
		q.Set("status", string(*p.Status))
	}

	return q
}

// MembershipsListMemberships200Response is a schema definition.
type MembershipsListMemberships200Response struct {
	Items      []Membership `json:"items"`
	TotalCount int          `json:"total_count"`
}

type MembershipsClient struct {
	c *client.Client
}

func NewMembershipsClient(c *client.Client) *MembershipsClient {
	return &MembershipsClient{c: c}
}

// List memberships of the current user.
func (c *MembershipsClient) List(ctx context.Context, params MembershipsListParams) (*MembershipsListMemberships200Response, error) {
	path := fmt.Sprintf("/v0.1/memberships")

	resp, err := c.c.Call(ctx, http.MethodGet, path, client.WithQueryValues(params.QueryValues()))
	if err != nil {
		return nil, fmt.Errorf("error building request: %v", err)
	}
	defer resp.Body.Close()

	switch resp.StatusCode {
	case http.StatusOK:
		var v MembershipsListMemberships200Response
		if err := json.NewDecoder(resp.Body).Decode(&v); err != nil {
			return nil, fmt.Errorf("decode response: %s", err.Error())
		}

		return &v, nil
	default:
		return nil, fmt.Errorf("unexpected response %d: %s", resp.StatusCode, http.StatusText(resp.StatusCode))
	}
}
